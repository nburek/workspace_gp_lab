
#include "xbasic_types.h"
#include "xuartlite_l.h"
#include "xparameters.h"
#include "widget.h"
#include "widget_table.h"
#include "packet.h"
#include "Graphics.h"
#include "Dial.h"

void print(char *str);

int main()
{
    struct widget w;

    Widget_move(&w, 0, 0);

	int x = 0;
		int y = 0;

//		B b;
//		b.r();


//		x = thing<int>(x);

		//positions for the different components
		int progressBarX = 160, progressBarY = 85;
		int lightsX = 160, lightsY = 35;

		u32 counter = 0;

		volatile int delayCounter = 0;

		//white out the entire screen to start
		for (x = 0; x<MAX_WIDTH; ++x){
			for (y = 0; y<MAX_HEIGHT; ++y){
				Xil_Out32(VGA_BASEADDR, ((y*384 + x)<<3)| (7));
			}
		}

		Dial_ctorr(&Dial);
		struct widget dial = Dial;

		Packet p;

		dial.runFunction(&dial, 1, &p);

		//stuff to draw a progress bar here
		drawCircle(progressBarX,progressBarY,15,BLACK,1);
		drawCircle(progressBarX+200,progressBarY,15,BLACK,1);
		drawRectangle(progressBarX,progressBarY-15,progressBarX+200,progressBarY+15,BLACK,1);
		drawCircle(progressBarX,progressBarY,13,GREEN,1);
		drawDigit(progressBarX-4,progressBarY+17,0,BLACK);
		drawNumber(progressBarX+188,progressBarY+17,100,BLACK);

		//Lights
		int i;
		for (i = 0; i<8; ++i)
			drawCircle(lightsX+30*i,lightsY, 10, BLACK, 1);

		//draw test digits 0-9
		for (i = 0; i<10; ++i)
			drawDigit(264+i*12,207,i,BLACK);

		while (1)
		{
			//this is getting sent as a temporary handshake of sorts to request a byte
			XUartLite_SendByte(XPAR_UARTLITE_1_BASEADDR, 128);

//			dial.runFunction(&dial, 2, &p);

			//stuff to draw a progress bar here
			u8 temperature = 0;
			u8 oldTemp = temperature;
			temperature = XUartLite_RecvByte(XPAR_UARTLITE_1_BASEADDR);
			if(oldTemp != temperature)
			{
				drawCircle(progressBarX+200,progressBarY,13,WHITE,1);
				drawRectangle(progressBarX,progressBarY-13,progressBarX+200,progressBarY+13,WHITE,1);
				drawRectangle(progressBarX,progressBarY-13,progressBarX+temperature,progressBarY+13,GREEN,1);
				if (temperature==200)
					drawCircle(progressBarX+200,progressBarY,13,GREEN,1);
			}

			//stuff to draw some lights here
			u8 buttons;
			buttons = XUartLite_RecvByte(XPAR_UARTLITE_1_BASEADDR);
			for (i = 0; i<8; ++i)
			{
				if ((buttons & (0x01<<i)) > 0)
					drawCircle(lightsX+30*i,lightsY,8,RED,1);
				else
					drawCircle(lightsX+30*i,lightsY,8,WHITE,1);
			}

			drawNumber(4, 207,counter, CYAN);
			++counter;

			delayCounter = 0;
			while (delayCounter<999999)
				delayCounter++;
		}


    return 0;
}
